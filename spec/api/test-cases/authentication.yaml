authentication_test_cases:
  
  user_registration:
    endpoint: POST /api/v1/register
    
    success_cases:
      - name: "成功註冊新用戶"
        request:
          body:
            name: "測試用戶"
            email: "test@example.com"
            password: "password123"
            password_confirmation: "password123"
        expected_response:
          status: 201
          body:
            user:
              id: "@integer"
              name: "測試用戶"
              email: "test@example.com"
              email_verified_at: null
              created_at: "@datetime"
              updated_at: "@datetime"
            token: "@string"
    
    failure_cases:
      - name: "重複電子郵件註冊失敗"
        precondition: "資料庫中已存在 test@example.com 用戶"
        request:
          body:
            name: "另一個用戶"
            email: "test@example.com"
            password: "password123"
            password_confirmation: "password123"
        expected_response:
          status: 422
          body:
            message: "The given data was invalid."
            errors:
              email: ["The email has already been taken."]
      
      - name: "密碼確認不符合"
        request:
          body:
            name: "測試用戶"
            email: "test2@example.com"
            password: "password123"
            password_confirmation: "password456"
        expected_response:
          status: 422
          body:
            message: "The given data was invalid."
            errors:
              password: ["The password confirmation does not match."]
      
      - name: "缺少必要欄位"
        request:
          body:
            name: "測試用戶"
            password: "password123"
        expected_response:
          status: 422
          body:
            message: "The given data was invalid."
            errors:
              email: ["The email field is required."]
              password_confirmation: ["The password confirmation field is required."]

  user_login:
    endpoint: POST /api/v1/login
    
    success_cases:
      - name: "成功登入取得令牌"
        precondition: "資料庫中存在用戶 test@example.com with password 'password123'"
        request:
          body:
            email: "test@example.com"
            password: "password123"
        expected_response:
          status: 200
          body:
            user:
              id: "@integer"
              name: "@string"
              email: "test@example.com"
              email_verified_at: "@nullable_datetime"
              created_at: "@datetime"
              updated_at: "@datetime"
            token: "@string"
    
    failure_cases:
      - name: "錯誤密碼登入失敗"
        precondition: "資料庫中存在用戶 test@example.com"
        request:
          body:
            email: "test@example.com"
            password: "wrongpassword"
        expected_response:
          status: 422
          body:
            message: "The given data was invalid."
            errors:
              email: ["These credentials do not match our records."]
      
      - name: "不存在用戶登入失敗"
        request:
          body:
            email: "nonexistent@example.com"
            password: "password123"
        expected_response:
          status: 422
          body:
            message: "The given data was invalid."
            errors:
              email: ["These credentials do not match our records."]
      
      - name: "缺少必要欄位"
        request:
          body:
            email: "test@example.com"
        expected_response:
          status: 422
          body:
            message: "The given data was invalid."
            errors:
              password: ["The password field is required."]

  forgot_password:
    endpoint: POST /api/v1/forgot-password
    description: "請求密碼重設連結"

    success_cases:
      - name: "本地用戶請求密碼重設"
        precondition: "資料庫中存在本地用戶 local@example.com (provider='local', password不為null)"
        request:
          body:
            email: "local@example.com"
        expected_response:
          status: 200
          body:
            message: "We have emailed your password reset link."
            may_require_oauth: false
        side_effects:
          - "發送密碼重設郵件給用戶"

      - name: "OAuth 用戶已設定密碼請求重設"
        precondition: "資料庫中存在 OAuth 用戶 oauth@example.com (provider='google', password不為null)"
        request:
          body:
            email: "oauth@example.com"
        expected_response:
          status: 200
          body:
            message: "We have emailed your password reset link."
            may_require_oauth: false
        side_effects:
          - "發送密碼重設郵件給用戶"

      - name: "OAuth 用戶無密碼收到 OAuth 提示"
        precondition: "資料庫中存在 OAuth 用戶 oauth-no-pw@example.com (provider='google', password為null)"
        request:
          body:
            email: "oauth-no-pw@example.com"
        expected_response:
          status: 200
          body:
            message: "If this email is registered, you will receive a password reset email. If you signed up using a third-party login (such as Google), please use that method to sign in directly."
            may_require_oauth: true
        side_effects:
          - "不發送郵件"

      - name: "不存在的 email 收到通用訊息（防止探測）"
        request:
          body:
            email: "nonexistent@example.com"
        expected_response:
          status: 200
          body:
            message: "We have emailed your password reset link."
            may_require_oauth: false
        side_effects:
          - "不發送郵件"

    failure_cases:
      - name: "缺少 email 欄位"
        request:
          body: {}
        expected_response:
          status: 422
          body:
            message: "The given data was invalid."
            errors:
              email: ["The email field is required."]

      - name: "無效的 email 格式"
        request:
          body:
            email: "invalid-email"
        expected_response:
          status: 422
          body:
            message: "The given data was invalid."
            errors:
              email: ["The email field must be a valid email address."]

      - name: "速率限制（每分鐘超過 6 次）"
        precondition: "同一 IP 在 1 分鐘內已請求 6 次"
        request:
          body:
            email: "test@example.com"
        expected_response:
          status: 429
          body:
            message: "Too Many Attempts."

  reset_password:
    endpoint: POST /api/v1/reset-password
    description: "使用 token 重設密碼"

    success_cases:
      - name: "使用有效 token 重設密碼"
        precondition: "用戶已請求密碼重設並收到有效 token"
        request:
          body:
            token: "valid_reset_token"
            email: "test@example.com"
            password: "newpassword123"
            password_confirmation: "newpassword123"
        expected_response:
          status: 200
          body:
            message: "Your password has been reset."
        side_effects:
          - "用戶密碼已更新"
          - "密碼重設 token 已失效"

    failure_cases:
      - name: "無效或過期的 token"
        request:
          body:
            token: "invalid_or_expired_token"
            email: "test@example.com"
            password: "newpassword123"
            password_confirmation: "newpassword123"
        expected_response:
          status: 422
          body:
            message: "The given data was invalid."
            errors:
              email: ["This password reset token is invalid or has expired."]

      - name: "密碼確認不符"
        request:
          body:
            token: "valid_reset_token"
            email: "test@example.com"
            password: "newpassword123"
            password_confirmation: "differentpassword"
        expected_response:
          status: 422
          body:
            message: "The given data was invalid."
            errors:
              password: ["The password confirmation does not match."]

      - name: "密碼不符合規則（少於 8 字元）"
        request:
          body:
            token: "valid_reset_token"
            email: "test@example.com"
            password: "short"
            password_confirmation: "short"
        expected_response:
          status: 422
          body:
            message: "The given data was invalid."
            errors:
              password: ["The password field must be at least 8 characters."]

  protected_endpoint_access:
    description: "測試需要認證的端點存取"

    success_cases:
      - name: "有效令牌存取受保護端點"
        precondition: "用戶已登入並持有有效 Bearer token"
        request:
          headers:
            Authorization: "Bearer valid_token_here"
          endpoint: "GET /api/v1/beers"
        expected_response:
          status: 200
          body: "@array"

    failure_cases:
      - name: "無令牌存取受保護端點"
        request:
          endpoint: "GET /api/v1/beers"
        expected_response:
          status: 401
          body:
            message: "Unauthenticated."

      - name: "無效令牌存取受保護端點"
        request:
          headers:
            Authorization: "Bearer invalid_token"
          endpoint: "GET /api/v1/beers"
        expected_response:
          status: 401
          body:
            message: "Unauthenticated."

      - name: "過期令牌存取受保護端點"
        request:
          headers:
            Authorization: "Bearer expired_token"
          endpoint: "GET /api/v1/beers"
        expected_response:
          status: 401
          body:
            message: "Unauthenticated."